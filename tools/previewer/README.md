# Previewer

The previewer plays FSL episodes with audio, displaying subtitles on a canvas. It generates a pre-computed timeline from parsed events, then plays through with synced gibberish audio.

---

## Usage

```bash
cd tools/previewer
python3 -m http.server 8001
# Open http://localhost:8001/tools/previewer/
```

1. Select an episode from the dropdown
2. Click **Load** (or it auto-loads your last episode)
3. Press **Space** or click the play button

---

## How It Works

```
FSL Script → Parser → Events → Timeline Generator → Playback
                                      ↓
                              [config.js settings]
```

### Pipeline

1. **Parse** — FSL text becomes flat events (via `../parser/parser.js`)
2. **Generate Timeline** — Events get durations and audio assignments
3. **Playback** — Events play in sequence with audio and subtitles

### Timeline Generation

Each event gets computed timing:

```javascript
{
  type: 'text',
  character: 'parth',
  state: 'neutral',
  text: 'Hello there!',
  
  // Added by timeline generator:
  duration: 800,        // ms (based on word count)
  startTime: 2500,      // ms from episode start
  endTime: 3300,        // ms
  audioPath: '../../assets/characters/parth/states/neutral/audio/gibberish.wav',
  audioStart: 12.4,     // random start point in audio file (seconds)
  audioDuration: 0.8    // how long to play (seconds)
}
```

### Gaps

The timeline inserts gaps between events:

- **Speaker change** — Gap when different character speaks
- **State change** — Smaller gap when same character changes emotion

---

## Config

Edit `config.js` to tune timing:

```javascript
export const config = {
  // Speech duration
  msPerWord: 400,        // Duration = words × this
  minDurationMs: 500,    // Floor for short words like "Oh"
  
  // Gaps
  pauseDurationMs: 2000, // Explicit [...] pauses
  speakerGapMs: 500,     // Gap between different speakers
  stateChangeGapMs: 200, // Gap when same speaker changes emotion
  
  // Location
  locationDurationMs: 0, // Duration for location changes (0 = instant)
};
```

Changes take effect on next **Load** (refresh page, click Load).

---

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Space` | Play / Pause |
| `←` `→` | Previous / Next event |
| `↑` `↓` | Toggle script/timeline drawer |
| `/` or `\` | Toggle debug bar |
| `F` | Toggle fullscreen |
| `Esc` | Close drawer |

---

## Canvas Rendering

The canvas renders at a fixed **1920×1080** internal resolution. CSS scales it to fit the container. This means:

- Everything scales proportionally (like a video)
- Resize the preview, go fullscreen — subtitles scale correctly
- Future: characters, effects will scale the same way

### Layers

```
0. Background  — Location visuals (placeholder: solid dark)
1. Characters  — Character video frames (not yet implemented)
2. Subtitles   — Dialogue text
3. Effects     — Transitions, filters (not yet implemented)
```

---

## Audio

Uses Web Audio API for precise playback:

- **One long audio file per character/state** (e.g., `gibberish.wav`)
- Timeline picks random start points for variety
- Same seed = same random choices = deterministic playback
- `audioContext.suspend()`/`resume()` for true pause (freezes in place)

---

## Persistence

Saved to `localStorage`:

| Key | Value |
|-----|-------|
| `foreigners_lastEpisode` | Last loaded episode filename |
| `foreigners_lastEvent` | Playhead position (event index) |
| `foreigners_previewWidth` | Custom preview size |

Refresh the page and you're right where you left off.

---

## UI Features

- **Corner resize** — Drag any corner to resize preview
- **Draggable drawer** — Drag top edge to resize script/timeline panel
- **Fullscreen** — Click icon or press `F`
- **Debug bar** — Shows current location, character, state
- **YouTube-style overlay** — Controls fade out during playback

---

## Files

| File | Purpose |
|------|---------|
| `index.html` | UI structure and styles |
| `main.js` | Main controller, event handling, playback loop |
| `config.js` | Timing configuration |
| `timeline.js` | Generates timeline from parsed events |
| `audio.js` | Web Audio API wrapper |
| `renderer.js` | Canvas rendering (subtitles, future: characters) |
| `seeded-random.js` | Deterministic random number generator |

---

## Dependencies

- `../parser/parser.js` — FSL parser
- `../../assets/manifest.json` — Asset manifest (generated by `tools/generate-manifest.js`)
- `../../assets/characters/*/states/*/audio/*.wav` — Character audio files
- `../../episodes/*.episode` — Episode scripts

